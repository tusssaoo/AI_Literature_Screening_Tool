<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ–‡çŒ®ç­›é€‰å¹³å° - æœ¬åœ°æ¨¡å‹ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            position: relative;
        }

        .header-top {
            display: flex;
            justify-content: center;
            padding: 0 20px;
            margin-bottom: 10px;
        }

        .btn-tutorial {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .btn-tutorial:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
            transform: translateY(-2px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* ä¸‰æ å¸ƒå±€ */
        .main-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            max-width: 1700px;
            margin: 0 auto;
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        .left-panel, .right-panel {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .center-panel {
            width: 800px;
            min-width: 800px;
            max-width: 800px;
            height: auto;
            overflow-y: visible;
        }
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ===== å·¦ä¾§ï¼šæ¨¡å‹åº“ ===== */
        .left-panel {
            width: 400px;
            min-width: 400px;
            max-width: 400px;
            box-sizing: border-box;
        }
        
        .ollama-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 16px;
        }
        
        .status-running {
            background: #d4edda;
            color: #155724;
        }
        
        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .model-category {
            margin-bottom: 20px;
        }
        
        .category-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .category-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: #667eea;
            border-radius: 2px;
        }
        
        .model-list-vertical {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .model-item-vertical {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s;
            border: 2px solid transparent;
        }
        
        .model-item-vertical:hover {
            background: #f0f4ff;
            border-color: #667eea;
            transform: translateX(4px);
        }
        
        .model-item-vertical.installed {
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            border-color: #10b981;
        }
        
        .model-item-vertical.selected {
            background: linear-gradient(135deg, #f5f3ff 0%, #ffffff 100%);
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .model-thumb {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .model-info-compact {
            flex: 1;
            min-width: 0;
        }
        
        .model-name-compact {
            font-size: 0.85rem;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .model-meta-compact {
            font-size: 0.75rem;
            color: #888;
            margin-top: 2px;
        }
        
        .model-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .drawer-toggle {
            width: 100%;
            padding: 10px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            color: #666;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }
        
        .drawer-toggle:hover {
            background: #e0e0e0;
            color: #667eea;
        }
        
        .hidden-models {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }
        
        .hidden-models.expanded {
            max-height: 2000px;
        }
        
        /* ===== ä¸­é—´ï¼šä¸»æ“ä½œåŒº ===== */
        .center-panel {
            width: 720px;
            min-width: 720px;
            max-width: 720px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box;
        }
        
        .section-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .step-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        input[type="file"]:hover,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 12px;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .preview-table th {
            background: #f0f0f0;
            font-weight: 600;
            color: #555;
        }
        
        .text-truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* ===== å³ä¾§ï¼šè¿è¡ŒåŠ¨æ€ ===== */
        .right-panel {
            width: 400px;
            min-width: 400px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .stats-grid-total {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 8px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card.yes {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        
        .stat-card.no {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        }
        
        .stat-card.unknown {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: 4px;
        }
        
        .progress-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .progress-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }
        
        .progress-percent {
            font-size: 0.9rem;
            font-weight: 600;
            color: #667eea;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            border-radius: 5px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #666;
        }
        
        .current-paper {
            background: #f0f4ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        
        .current-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 4px;
        }
        
        .current-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .log-section {
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
            min-height: 0;
        }
        
        .log-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            margin-bottom: 6px;
            background: white;
            border-radius: 6px;
            font-size: 0.8rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .log-index {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .log-yes {
            background: #d4edda;
            color: #155724;
        }
        
        .log-no {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #333;
            min-width: 0;
        }
        
        .log-result {
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .result-yes {
            background: #d4edda;
            color: #155724;
        }

        .result-no {
            background: #f8d7da;
            color: #721c24;
        }

        .result-unknown {
            background: #fef3c7;
            color: #92400e;
        }

        .log-unknown {
            background: #fef3c7;
            color: #92400e;
        }

        .log-header {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-expand {
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .btn-expand:hover {
            background: #667eea;
            color: white;
        }

        .log-details {
            width: 100%;
            margin-top: 8px;
            display: none;
            box-sizing: border-box;
        }

        .log-details.expanded {
            display: block;
        }

        .log-details-content {
            color: #333;
            font-size: 0.75rem;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .log-item.analyzing {
            background: #fffbeb;
            border-left: 3px solid #f59e0b;
        }

        .log-item.analyzing .log-index {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .log-result.analyzing {
            background: #fef3c7;
            color: #92400e;
            font-style: italic;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .download-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e0e0e0;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        /* æ¨¡å‹ä¸‹è½½è¿›åº¦ */
        .download-progress-vertical {
            margin-top: 12px;
            padding: 12px;
            background: #f0f4ff;
            border-radius: 8px;
        }
        
        .download-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 6px;
        }
        
        /* AIå¹³å°æŒ‰é’®ç½‘æ ¼ */
        .ai-platform-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        /* æç¤ºè¯æ¨¡æ¿æ¡† */
        .prompt-template-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .btn-copy-small {
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-copy-small:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-copy-small.copied {
            background: #10b981;
            border-color: #10b981;
        }
        
        .prompt-content {
            padding: 16px;
            margin: 0;
            font-family: 'Courier New', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.7;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
            background: #fff;
        }
        
        .prompt-content:empty::before,
        .prompt-content.placeholder {
            color: #999;
            font-style: italic;
        }
        
        .btn-platform {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 14px 8px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #667eea;
        }
        
        .btn-platform:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }
        
        .btn-platform:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .platform-icon {
            font-size: 1.6rem;
            margin-bottom: 4px;
        }
        
        .platform-name {
            font-size: 0.8rem;
        }
        
        /* ç»Ÿä¸€æ‚¬åœæ ·å¼ */
        .btn-platform:hover:not(:disabled) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        /* æ•™ç¨‹æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            transform: translateY(-20px);
            transition: all 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(85vh - 80px);
        }

        .tutorial-section {
            margin-bottom: 24px;
        }

        .tutorial-section:last-child {
            margin-bottom: 0;
        }

        .tutorial-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tutorial-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tutorial-step {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .step-content p {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.5;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .feature-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 16px;
            border-left: 3px solid #667eea;
        }

        .feature-card h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .feature-card p {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.4;
        }

        .workflow-diagram {
            background: linear-gradient(135deg, #f0f4ff 0%, #f8f9fa 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .workflow-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .workflow-item {
            background: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }

        .workflow-arrow {
            color: #667eea;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .feature-grid {
                grid-template-columns: 1fr;
            }

            .workflow-flow {
                flex-direction: column;
            }

            .workflow-arrow {
                transform: rotate(90deg);
            }
        }

        /* å“åº”å¼ */
        @media (max-width: 1600px) {
            .main-container {
                grid-template-columns: 400px 720px 400px;
                overflow-x: auto;
            }
        }

        /* ===== AIäº¤äº’æŠ½å±‰ ===== */
        .ai-interaction-drawer {
            position: fixed;
            right: -600px;
            top: 0;
            width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 30px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .ai-interaction-drawer.open {
            right: 0;
        }

        .drawer-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .drawer-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drawer-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .interaction-item {
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .interaction-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #666;
        }

        .interaction-paper-id {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .interaction-type {
            font-weight: 500;
        }

        .interaction-type.send {
            color: #667eea;
        }

        .interaction-type.receive {
            color: #10b981;
        }

        .interaction-time {
            margin-left: auto;
            font-size: 0.75rem;
            color: #999;
        }

        .interaction-content {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }

        .interaction-item.receive .interaction-content {
            border-left-color: #10b981;
        }

        .interaction-label {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .interaction-text {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .interaction-text.streaming {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .drawer-toggle-btn {
            position: fixed;
            right: 20px;
            bottom: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drawer-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .drawer-toggle-btn .badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .drawer-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .drawer-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .drawer-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .drawer-btn:hover {
            background: #f3f4f6;
        }

        .drawer-btn.primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .drawer-btn.primary:hover {
            background: #5a67d8;
        }

        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 400px 720px 400px;
                overflow-x: auto;
            }
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 400px 720px 400px;
                overflow-x: auto;
            }

            .left-panel,
            .right-panel {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .ai-platform-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header-top {
                justify-content: center;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <button class="btn btn-tutorial" onclick="showTutorial()">
                ä½¿ç”¨æ•™ç¨‹
            </button>
        </div>
        <h1>AIæ–‡çŒ®ç­›é€‰å¹³å°</h1>
        <p>æœ¬åœ°è½»é‡åŒ–è¿è¡Œï¼Œæ•°æ®éšç§ä¿æŠ¤</p>
    </div>
    
    <div class="main-container">
        <!-- å·¦ä¾§ï¼šæ¨¡å‹åº“ -->
        <div class="panel left-panel">
            <div class="panel-title">
                <span>ğŸ“š</span> æœ¬åœ°æ¨¡å‹åº“
            </div>
            
            <div class="model-hint" style="background: #f0f4ff; border-left: 4px solid #667eea; padding: 10px 12px; margin-bottom: 12px; border-radius: 8px; font-size: 0.8rem; color: #555;">
                <span style="font-weight: 600; color: #667eea;">ğŸ’¡ æç¤ºï¼š</span>æ¨¡å‹å¤§å°(B)å°äºè¿è¡Œå†…å­˜å¤§å° Ã— 2/3 ä¸ºå®œ
            </div>
            
            <div id="ollamaStatus" class="ollama-status status-stopped">
                <span class="status-dot"></span>
                <span id="statusText">æ£€æŸ¥ä¸­...</span>
            </div>
            
            <div id="modelSection">
                <!-- å·²å®‰è£…æ¨¡å‹ -->
                <div class="model-category">
                    <div class="category-title">å·²å®‰è£…</div>
                    <div id="installedModelsList" class="model-list-vertical">
                        <p style="color: #999; font-size: 0.85rem;">æš‚æ— å·²å®‰è£…æ¨¡å‹</p>
                    </div>
                </div>
                
                <!-- å¯é€‰æ¨¡å‹ -->
                <div class="model-category">
                    <div class="category-title">å¯é€‰ä¸‹è½½</div>
                    <div id="recommendedModelsList" class="model-list-vertical">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                    <button class="drawer-toggle" id="drawerBtn" onclick="toggleModelDrawer()">
                        æŸ¥çœ‹æ›´å¤šæ¨¡å‹ â–¼
                    </button>
                    <div id="hiddenModelsList" class="hidden-models">
                        <!-- åŠ¨æ€å¡«å……æ›´å¤šæ¨¡å‹ -->
                    </div>
                </div>
            </div>
            
            <div id="ollamaNotRunning" class="alert alert-error hidden">
                è¯·å…ˆå®‰è£…å¹¶å¯åŠ¨OllamaæœåŠ¡<br>
                <code style="font-size: 0.8rem;">ollama serve</code>
            </div>
            
            <!-- ä¸‹è½½è¿›åº¦ -->
            <div id="downloadProgressVertical" class="download-progress-vertical hidden">
                <div class="download-label" id="downloadLabel">ä¸‹è½½ä¸­...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="modelDownloadProgress" style="width: 0%"></div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px;" id="cancelDownloadBtn" onclick="cancelDownload()">
                    å–æ¶ˆä¸‹è½½
                </button>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šä¸»æ“ä½œåŒº -->
        <div class="panel center-panel">
            <!-- æ­¥éª¤1ï¼šä¸Šä¼ æ–‡ä»¶ -->
            <div class="section-card">
                <div class="section-header">
                    <div class="step-badge">1</div>
                    <div class="section-title">ä¸Šä¼ PubMedæ–‡çŒ®æ–‡ä»¶</div>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©æ–‡çŒ®æ–‡ä»¶ï¼ˆæ”¯æŒPubMedå¯¼å‡ºçš„.txtæ–‡ä»¶æˆ–Excelæ–‡ä»¶ï¼‰</label>
                    <input type="file" id="fileInput" accept=".txt,.xlsx,.xls" onchange="uploadFile()">
                    <div style="font-size: 0.8rem; color: #888; margin-top: 6px;">
                        æ”¯æŒæ ¼å¼ï¼šPubMed MEDLINE (.txt) | Excel (.xlsx, .xls)
                    </div>
                </div>

                <div id="uploadResult"></div>
                
                <div id="previewSection" class="hidden" style="margin-top: 16px;">
                    <label style="font-size: 0.85rem; color: #666;">æ–‡çŒ®é¢„è§ˆ</label>
                    <div style="overflow-x: auto; max-height: 240px; overflow-y: auto;">
                        <table class="preview-table" id="previewTable">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤2ï¼šè®¾ç½®ç­›é€‰æ ‡å‡† -->
            <div class="section-card">
                <div class="section-header">
                    <div class="step-badge">2</div>
                    <div class="section-title">è®¾ç½®ç­›é€‰æ ‡å‡†</div>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©åˆ†ææ¨¡å‹</label>
                    <select id="selectedModel">
                        <option value="">è¯·å…ˆå®‰è£…æ¨¡å‹</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>è¾“å…¥ç­›é€‰æ ‡å‡†</label>
                    <textarea id="userCriteria" placeholder="ä¾‹å¦‚ï¼š&#10;- ç ”ç©¶å¿…é¡»æ˜¯éšæœºå¯¹ç…§è¯•éªŒ&#10;- ç ”ç©¶å¯¹è±¡å¿…é¡»æ˜¯æˆå¹´äºº&#10;- æ’é™¤åŠ¨ç‰©å®éªŒ" oninput="generateFullPrompt()"></textarea>
                </div>
                
                <div class="form-group">
                    <label>å®Œæ•´çš„AIä¼˜åŒ–æç¤ºè¯ï¼ˆå¤åˆ¶ä»¥ä¸‹å†…å®¹åˆ°AIå¹³å°ï¼‰</label>
                    <div class="prompt-template-box" id="promptTemplateBox">
                        <div class="prompt-header">
                            <span>ğŸ“‹ ä¼˜åŒ–æç¤ºè¯æ¨¡æ¿</span>
                            <button class="btn-copy-small" onclick="copyFullPrompt()">ä¸€é”®å¤åˆ¶</button>
                        </div>
                        <pre id="fullPromptText" class="prompt-content">è¯·å…ˆåœ¨ä¸Šæ–¹çš„"è¾“å…¥ç­›é€‰æ ‡å‡†"æ¡†ä¸­è¾“å…¥æ‚¨çš„ç­›é€‰æ ‡å‡†...</pre>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©AIå¹³å°æ‰“å¼€ï¼ˆç²˜è´´ä¸Šæ–¹æç¤ºè¯ï¼‰</label>
                    <div class="ai-platform-grid">
                        <button class="btn btn-platform doubao" onclick="openAIPlatform('doubao')" id="btnDoubao">
                            <span class="platform-name">è±†åŒ…</span>
                        </button>
                        <button class="btn btn-platform zhipu" onclick="openAIPlatform('zhipu')" id="btnZhipu">
                            <span class="platform-name">æ™ºè°±æ¸…è¨€</span>
                        </button>
                        <button class="btn btn-platform deepseek" onclick="openAIPlatform('deepseek')" id="btnDeepseek">
                            <span class="platform-name">DeepSeek</span>
                        </button>
                        <button class="btn btn-platform kimi" onclick="openAIPlatform('kimi')" id="btnKimi">
                            <span class="platform-name">Kimi</span>
                        </button>
                        <button class="btn btn-platform qwen" onclick="openAIPlatform('qwen')" id="btnQwen">
                            <span class="platform-name">é€šä¹‰åƒé—®</span>
                        </button>
                        <button class="btn btn-platform yiyan" onclick="openAIPlatform('yiyan')" id="btnYiyan">
                            <span class="platform-name">æ–‡å¿ƒä¸€è¨€</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 16px;">
                    <label>AIä¼˜åŒ–åçš„ç­›é€‰æ ‡å‡†ï¼ˆç²˜è´´å¤–éƒ¨AIçš„å›å¤ï¼‰</label>
                    <textarea id="enhancedPrompt" placeholder="å°†è±†åŒ…/æ™ºè°±ç­‰AIä¼˜åŒ–åçš„ç­›é€‰æ ‡å‡†ç²˜è´´åˆ°è¿™é‡Œ...

ä¼˜åŒ–åçš„æ ‡å‡†åº”è¯¥ï¼š
- æ¯”åŸå§‹æè¿°æ›´ä¸“ä¸šæ¸…æ™°
- ä½¿ç”¨å‡†ç¡®çš„å­¦æœ¯æœ¯è¯­
- é€»è¾‘ç»“æ„æ˜ç¡®
- æ˜“äºAIç†è§£åˆ¤æ–­"></textarea>
                </div>
                
                <!-- æ“ä½œæŒ‰é’®ç»„ -->
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="startAnalysis()" id="analyzeBtn" disabled>
                        <span>â–¶</span> å¼€å§‹åˆ†æ
                    </button>
                    <button class="btn btn-secondary" onclick="exportWithoutAnalysis()" id="exportBtn" disabled>
                        <span>ğŸ“¥</span> ä¸åˆ†æå¯¼å‡ºExcel
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šè¿è¡ŒåŠ¨æ€ -->
        <div class="panel right-panel">
            <div class="panel-title">
                <span>ğŸ“Š</span> è¿è¡ŒåŠ¨æ€
            </div>
            
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid-total">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">æ€»è®¡</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card yes">
                    <div class="stat-number" id="yesCount">0</div>
                    <div class="stat-label">ç¬¦åˆ</div>
                </div>
                <div class="stat-card no">
                    <div class="stat-number" id="noCount">0</div>
                    <div class="stat-label">ä¸ç¬¦åˆ</div>
                </div>
                <div class="stat-card unknown">
                    <div class="stat-number" id="unknownCount">0</div>
                    <div class="stat-label">æœªçŸ¥</div>
                </div>
            </div>
            
            <!-- åˆ†æè¿›åº¦ -->
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-title">åˆ†æè¿›åº¦</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="analysisProgressBar" style="width: 0%"></div>
                </div>
                <div class="progress-info">
                    <span id="currentIndex">0 / 0</span>
                    <span id="etaText">ç­‰å¾…å¼€å§‹...</span>
                </div>
                <div id="currentPaperInfo" class="current-paper hidden">
                    <div class="current-label">å½“å‰åˆ†æ</div>
                    <div class="current-title" id="currentPaperTitle">-</div>
                </div>
            </div>
            
            <!-- å®æ—¶æ—¥å¿— -->
            <div class="log-section" id="logSection">
                <div class="category-title" style="margin-bottom: 10px;">å®æ—¶æ—¥å¿—</div>
                <div id="logContainer">
                    <p style="color: #999; font-size: 0.8rem; text-align: center;">ç­‰å¾…å¼€å§‹åˆ†æ...</p>
                </div>
            </div>
            
            <!-- ä¸‹è½½ç»“æœ -->
            <div id="downloadSection" class="download-section hidden">
                <button class="btn btn-success" style="width: 100%;" onclick="downloadResult()">
                    <span>ğŸ“¥</span> ä¸‹è½½ç­›é€‰ç»“æœ
                </button>
                <input type="hidden" id="resultDownloadUrl" value="">
            </div>
        </div>
    </div>

    <!-- æ•™ç¨‹æ¨¡æ€æ¡† -->
    <div id="tutorialModal" class="modal-overlay" onclick="closeTutorial(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">ä½¿ç”¨æ•™ç¨‹</div>
                <button class="modal-close" onclick="closeTutorial()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- å·¥ä½œæµç¨‹ -->
                <div class="tutorial-section">
                    <div class="tutorial-title">æ•´ä½“å·¥ä½œæµç¨‹</div>
                    <div class="workflow-diagram">
                        <div class="workflow-flow">
                            <div class="workflow-item">1. ä¸Šä¼ PubMedæ–‡ä»¶</div>
                            <span class="workflow-arrow">&rarr;</span>
                            <div class="workflow-item">2. è®¾ç½®ç­›é€‰æ ‡å‡†</div>
                            <span class="workflow-arrow">&rarr;</span>
                            <div class="workflow-item">3. å¤–éƒ¨AIä¼˜åŒ–</div>
                            <span class="workflow-arrow">&rarr;</span>
                            <div class="workflow-item">4. æœ¬åœ°AIåˆ†æ</div>
                            <span class="workflow-arrow">&rarr;</span>
                            <div class="workflow-item">5. å¯¼å‡ºç»“æœ</div>
                        </div>
                    </div>
                </div>

                <!-- è¯¦ç»†æ­¥éª¤ -->
                <div class="tutorial-section">
                    <div class="tutorial-title">è¯¦ç»†æ“ä½œæ­¥éª¤</div>
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>ä¸Šä¼ PubMedæ–‡çŒ®æ–‡ä»¶</h4>
                                <p>ä»PubMedå¯¼å‡ºæ–‡çŒ®åº“ä¸ºtxtæ ¼å¼ï¼ˆMEDLINEæ ¼å¼ï¼‰ï¼Œç‚¹å‡»"è§£ææ–‡çŒ®"æŒ‰é’®ä¸Šä¼ æ–‡ä»¶ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨æå–æ ‡é¢˜ã€æ‘˜è¦ã€å…³é”®è¯ã€å›½å®¶ã€æ—¥æœŸã€ä½œè€…ç­‰ä¿¡æ¯ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>é€‰æ‹©æœ¬åœ°AIæ¨¡å‹</h4>
                                <p>åœ¨å·¦ä¾§æ¨¡å‹åº“ä¸­æŸ¥çœ‹å·²å®‰è£…çš„æ¨¡å‹ï¼Œæˆ–ä¸‹è½½æ¨èæ¨¡å‹ã€‚ç„¶ååœ¨ä¸­é—´é¢æ¿é€‰æ‹©è¦ç”¨äºç­›é€‰çš„æ¨¡å‹ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>è¾“å…¥ç­›é€‰æ ‡å‡†</h4>
                                <p>åœ¨"è®¾ç½®ç­›é€‰æ ‡å‡†"åŒºåŸŸè¾“å…¥æ‚¨çš„ç­›é€‰æ¡ä»¶ï¼Œå¦‚ç ”ç©¶ç±»å‹ã€äººç¾¤ç‰¹å¾ã€æ’é™¤æ ‡å‡†ç­‰ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–æç¤ºè¯ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>ä½¿ç”¨å¤–éƒ¨AIä¼˜åŒ–æç¤ºè¯</h4>
                                <p>ç‚¹å‡»"ä¸€é”®å¤åˆ¶"å¤åˆ¶ä¼˜åŒ–åçš„æç¤ºè¯ï¼Œç„¶åé€‰æ‹©è±†åŒ…ã€æ™ºè°±æ¸…è¨€ç­‰AIå¹³å°æ‰“å¼€ï¼Œç²˜è´´æç¤ºè¯è·å–æ›´ä¸“ä¸šçš„ç­›é€‰æ ‡å‡†æè¿°ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h4>ç²˜è´´ä¼˜åŒ–ç»“æœå¹¶å¼€å§‹åˆ†æ</h4>
                                <p>å°†å¤–éƒ¨AIä¼˜åŒ–åçš„ç­›é€‰æ ‡å‡†ç²˜è´´åˆ°"AIä¼˜åŒ–åçš„ç­›é€‰æ ‡å‡†"æ–‡æœ¬æ¡†ä¸­ï¼Œç‚¹å‡»"å¼€å§‹åˆ†æ"æŒ‰é’®ï¼Œæœ¬åœ°AIå°†æ‰¹é‡å¤„ç†æ‰€æœ‰æ–‡çŒ®ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">6</div>
                            <div class="step-content">
                                <h4>æŸ¥çœ‹ç»“æœå¹¶å¯¼å‡º</h4>
                                <p>å³ä¾§è¿è¡ŒåŠ¨æ€é¢æ¿å®æ—¶æ˜¾ç¤ºåˆ†æè¿›åº¦å’Œç»Ÿè®¡ç»“æœã€‚åˆ†æå®Œæˆåï¼Œç‚¹å‡»"ä¸‹è½½ç­›é€‰ç»“æœ"å¯¼å‡ºåŒ…å«ç­›é€‰ç»“æœçš„Excelæ–‡ä»¶ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¿å—åŠŸèƒ½ä»‹ç» -->
                <div class="tutorial-section">
                    <div class="tutorial-title">å„æ¿å—åŠŸèƒ½ä»‹ç»</div>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4>å·¦ä¾§ï¼šæ¨¡å‹åº“</h4>
                            <p>å±•ç¤ºå·²å®‰è£…çš„æœ¬åœ°æ¨¡å‹å’Œæ¨èä¸‹è½½çš„æ¨¡å‹ã€‚ç‚¹å‡»æ¨¡å‹å¯é€‰æ‹©ç”¨äºåˆ†æï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®å¯ä¸‹è½½æ–°æ¨¡å‹ã€‚</p>
                        </div>
                        <div class="feature-card">
                            <h4>ä¸­é—´ï¼šæ“ä½œåŒº</h4>
                            <p>åŒ…å«æ–‡ä»¶ä¸Šä¼ ã€ç­›é€‰æ ‡å‡†è®¾ç½®ã€AIå¹³å°é€‰æ‹©å’Œæ“ä½œæŒ‰é’®ã€‚æ˜¯ä¸»è¦çš„å·¥ä½œåŒºåŸŸã€‚</p>
                        </div>
                        <div class="feature-card">
                            <h4>å³ä¾§ï¼šè¿è¡ŒåŠ¨æ€</h4>
                            <p>å®æ—¶æ˜¾ç¤ºåˆ†æç»Ÿè®¡ï¼ˆæ€»è®¡/ç¬¦åˆ/ä¸ç¬¦åˆï¼‰ã€è¿›åº¦æ¡ã€å½“å‰åˆ†ææ–‡çŒ®æ ‡é¢˜å’Œåˆ†ææ—¥å¿—ã€‚</p>
                        </div>
                    </div>
                </div>

                <!-- æ³¨æ„äº‹é¡¹ -->
                <div class="tutorial-section">
                    <div class="tutorial-title">ä½¿ç”¨é¡»çŸ¥</div>
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <div class="step-number">!</div>
                            <div class="step-content">
                                <h4>OllamaæœåŠ¡</h4>
                                <p>ä½¿ç”¨å‰è¯·ç¡®ä¿å·²å®‰è£…Ollamaå¹¶è¿è¡ŒæœåŠ¡ï¼ˆå‘½ä»¤ï¼šollama serveï¼‰ã€‚æ‰€æœ‰AIåˆ†æå‡åœ¨æœ¬åœ°å®Œæˆï¼Œæ•°æ®ä¸ä¼šä¸Šä¼ åˆ°äº‘ç«¯ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">!</div>
                            <div class="step-content">
                                <h4>æ¨¡å‹é€‰æ‹©å»ºè®®</h4>
                                <p>æ¨èä½¿ç”¨qwen2.5:7bæˆ–qwen2.5:14bæ¨¡å‹ï¼Œåœ¨å‡†ç¡®ç‡å’Œé€Ÿåº¦ä¹‹é—´å–å¾—å¹³è¡¡ã€‚è¾ƒå¤§çš„æ¨¡å‹å‡†ç¡®ç‡æ›´é«˜ä½†é€Ÿåº¦è¾ƒæ…¢ã€‚</p>
                            </div>
                        </div>
                        <div class="tutorial-step">
                            <div class="step-number">!</div>
                            <div class="step-content">
                                <h4>å¤–éƒ¨AIä¼˜åŒ–</h4>
                                <p>å¤–éƒ¨AIï¼ˆè±†åŒ…ç­‰ï¼‰ä»…ç”¨äºä¼˜åŒ–æç¤ºè¯çš„è¯­è¨€è¡¨è¾¾ï¼Œå®é™…çš„æ–‡çŒ®ç­›é€‰åˆ¤æ–­ç”±æœ¬åœ°AIå®Œæˆï¼Œç¡®ä¿æ•°æ®éšç§ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentModels = [];
        let installedModelNames = [];
        let allModelLibrary = [];
        let selectedModelName = '';
        let parsedRecords = [];
        let analysisResults = [];
        let isAnalyzing = false;
        let downloadAbortController = null;
        let isDownloading = false;

        // é¡µé¢åŠ è½½
        window.onload = function() {
            checkOllamaStatus();
        };

        // æ˜¾ç¤ºæ•™ç¨‹
        function showTutorial() {
            document.getElementById('tutorialModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // å…³é—­æ•™ç¨‹
        function closeTutorial(event) {
            if (!event || event.target.id === 'tutorialModal' || event.target.classList.contains('modal-close')) {
                document.getElementById('tutorialModal').classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        // ESCé”®å…³é—­æ•™ç¨‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTutorial();
            }
        });

        async function checkOllamaStatus() {
            try {
                const response = await fetch('/api/ollama_status');
                const data = await response.json();
                
                const statusBadge = document.getElementById('ollamaStatus');
                const statusText = document.getElementById('statusText');
                const notRunningMsg = document.getElementById('ollamaNotRunning');
                const modelSection = document.getElementById('modelSection');
                
                if (data.running) {
                    statusBadge.className = 'ollama-status status-running';
                    statusText.textContent = 'è¿è¡Œä¸­';
                    notRunningMsg.classList.add('hidden');
                    modelSection.classList.remove('hidden');
                    
                    currentModels = data.models || [];
                    installedModelNames = currentModels.map(m => m.name);
                    allModelLibrary = data.recommended || [];
                    
                    renderModelLists();
                    updateModelSelect();
                } else {
                    statusBadge.className = 'ollama-status status-stopped';
                    statusText.textContent = 'æœªè¿è¡Œ';
                    notRunningMsg.classList.remove('hidden');
                    modelSection.classList.add('hidden');
                }
            } catch (error) {
                document.getElementById('statusText').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('ollamaNotRunning').classList.remove('hidden');
            }
        }

        function getModelInitials(name) {
            const parts = name.split(':');
            const family = parts[0].replace(/\d/g, '').substring(0, 3).toUpperCase();
            const version = parts[1] || '';
            const numMatch = version.match(/(\d+)/);
            return family + (numMatch ? numMatch[1] : '');
        }

        function renderModelLists() {
            // å·²å®‰è£…æ¨¡å‹
            const installedContainer = document.getElementById('installedModelsList');
            if (currentModels.length === 0) {
                installedContainer.innerHTML = '<p style="color: #999; font-size: 0.85rem;">æš‚æ— å·²å®‰è£…æ¨¡å‹</p>';
            } else {
                installedContainer.innerHTML = currentModels.map(model => `
                    <div class="model-item-vertical installed ${selectedModelName === model.name ? 'selected' : ''}" 
                         onclick="selectModel('${model.name}')">
                        <div class="model-thumb">${getModelInitials(model.name)}</div>
                        <div class="model-info-compact">
                            <div class="model-name-compact">${model.name}</div>
                            <div class="model-meta-compact">${formatSize(model.size)}</div>
                        </div>
                        <div class="model-check">âœ“</div>
                    </div>
                `).join('');
            }
            
            // æ¨èæ¨¡å‹ï¼ˆå‰5ä¸ªæœªå®‰è£…ï¼‰
            const recommendedContainer = document.getElementById('recommendedModelsList');
            const notInstalled = allModelLibrary.filter(m => !installedModelNames.includes(m.name));
            const visibleModels = notInstalled.slice(0, 5);
            
            recommendedContainer.innerHTML = visibleModels.map(model => `
                <div class="model-item-vertical" onclick="downloadModel('${model.name}')">
                    <div class="model-thumb">${getModelInitials(model.name)}</div>
                    <div class="model-info-compact">
                        <div class="model-name-compact">${model.name}</div>
                        <div class="model-meta-compact">${model.size} â¬‡</div>
                    </div>
                </div>
            `).join('');
            
            // éšè—æ¨¡å‹
            const hiddenContainer = document.getElementById('hiddenModelsList');
            const hiddenModels = notInstalled.slice(5);
            
            if (hiddenModels.length > 0) {
                hiddenContainer.innerHTML = hiddenModels.map(model => `
                    <div class="model-item-vertical" onclick="downloadModel('${model.name}')">
                        <div class="model-thumb">${getModelInitials(model.name)}</div>
                        <div class="model-info-compact">
                            <div class="model-name-compact">${model.name}</div>
                            <div class="model-meta-compact">${model.size} â¬‡</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleModelDrawer() {
            const hiddenList = document.getElementById('hiddenModelsList');
            const btn = document.getElementById('drawerBtn');
            
            if (hiddenList.classList.contains('expanded')) {
                hiddenList.classList.remove('expanded');
                btn.textContent = 'æŸ¥çœ‹æ›´å¤šæ¨¡å‹ â–¼';
            } else {
                hiddenList.classList.add('expanded');
                btn.textContent = 'æ”¶èµ· â–²';
            }
        }

        function selectModel(modelName) {
            selectedModelName = modelName;
            renderModelLists();
            
            const select = document.getElementById('selectedModel');
            select.value = modelName;
        }

        function updateModelSelect() {
            const select = document.getElementById('selectedModel');
            
            // æ›´æ–°åˆ†ææŒ‰é’®çŠ¶æ€
            if (currentModels.length === 0) {
                select.innerHTML = '<option value="">è¯·å…ˆå®‰è£…æ¨¡å‹</option>';
                document.getElementById('analyzeBtn').disabled = true;
            } else {
                select.innerHTML = currentModels.map(m => 
                    `<option value="${m.name}">${m.name}</option>`
                ).join('');
                
                if (parsedRecords.length > 0) {
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('exportBtn').disabled = false;
                }
            }
            

        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æç¤ºè¯ç”Ÿæˆ
            generateFullPrompt();
        });

        async function downloadModel(modelName) {
            const progressDiv = document.getElementById('downloadProgressVertical');
            const progressBar = document.getElementById('modelDownloadProgress');
            const downloadLabel = document.getElementById('downloadLabel');
            const cancelBtn = document.getElementById('cancelDownloadBtn');
            
            // å¦‚æœæ­£åœ¨ä¸‹è½½ï¼Œå…ˆå–æ¶ˆ
            if (isDownloading && downloadAbortController) {
                downloadAbortController.abort();
            }
            
            // åˆ›å»ºæ–°çš„AbortController
            downloadAbortController = new AbortController();
            isDownloading = true;
            
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
            downloadLabel.textContent = `æ­£åœ¨ä¸‹è½½ ${modelName}...`;
            cancelBtn.textContent = 'å–æ¶ˆä¸‹è½½';
            cancelBtn.disabled = false;
            
            try {
                const response = await fetch('/api/pull_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName }),
                    signal: downloadAbortController.signal
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(l => l.trim());
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                console.log('[ä¸‹è½½è¿›åº¦]', data);  // è°ƒè¯•æ—¥å¿—
                                
                                if (data.status === 'downloading') {
                                    progressBar.style.width = data.progress + '%';
                                    const speed = data.speed || 0;
                                    const eta = data.eta || 'è®¡ç®—ä¸­...';
                                    const completed = data.completed || 0;
                                    const total = data.total || 0;
                                    const path = data.path || '';
                                    const message = data.message || '';
                                    
                                    let statusText = `æ­£åœ¨ä¸‹è½½ ${modelName}... ${data.progress.toFixed(1)}%`;
                                    if (message && message !== 'downloading') {
                                        statusText += ` (${message})`;
                                    }
                                    
                                    downloadLabel.innerHTML = statusText + '<br>' +
                                        `<small style="color: #666;">` +
                                        `é€Ÿåº¦: ${speed.toFixed(2)} MB/s | å‰©ä½™: ${eta}<br>` +
                                        `è¿›åº¦: ${completed.toFixed(2)} / ${total.toFixed(2)} MB<br>` +
                                        `ä¿å­˜è·¯å¾„: ${path}` +
                                        `</small>`;
                                } else if (data.status === 'success') {
                                    progressBar.style.width = '100%';
                                    const message = data.message || 'ä¸‹è½½å®Œæˆï¼';
                                    // æ£€æŸ¥æ˜¯å¦æ˜¯å·²å­˜åœ¨çš„æ¶ˆæ¯ï¼ˆåŒ…æ‹¬è‹±æ–‡å’Œä¸­æ–‡ï¼‰
                                    const isAlreadyExists = message === 'already exists' || 
                                                           message.includes('å·²å­˜åœ¨') ||
                                                           message.includes('æ— éœ€ä¸‹è½½');
                                    downloadLabel.textContent = isAlreadyExists ? 'æ¨¡å‹å·²å­˜åœ¨ï¼' : 'ä¸‹è½½å®Œæˆï¼';
                                    setTimeout(() => {
                                        progressDiv.classList.add('hidden');
                                        isDownloading = false;
                                        checkOllamaStatus();
                                    }, 1000);
                                } else if (data.status === 'error') {
                                    downloadLabel.textContent = `ä¸‹è½½å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`;
                                    setTimeout(() => {
                                        progressDiv.classList.add('hidden');
                                        isDownloading = false;
                                    }, 3000);
                                }
                            } catch (e) {}
                        }
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    downloadLabel.textContent = 'ä¸‹è½½å·²å–æ¶ˆ';
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                    }, 1500);
                } else {
                    downloadLabel.textContent = `ä¸‹è½½å¤±è´¥: ${error.message}`;
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                    }, 3000);
                }
                console.error('ä¸‹è½½å¤±è´¥:', error);
            } finally {
                isDownloading = false;
                downloadAbortController = null;
            }
        }

        function cancelDownload() {
            if (downloadAbortController && isDownloading) {
                downloadAbortController.abort();
                const cancelBtn = document.getElementById('cancelDownloadBtn');
                const downloadLabel = document.getElementById('downloadLabel');
                cancelBtn.disabled = true;
                downloadLabel.textContent = 'æ­£åœ¨å–æ¶ˆ...';
            }
        }

        function formatSize(bytes) {
            if (!bytes) return '-';
            const gb = bytes / (1024 * 1024 * 1024);
            if (gb >= 1) return gb.toFixed(1) + ' GB';
            const mb = bytes / (1024 * 1024);
            return mb.toFixed(1) + ' MB';
        }

        function showAlert(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function clearAlert(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showAlert('uploadResult', '<span class="loading"></span> æ­£åœ¨è§£ææ–‡çŒ®...', 'info');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    parsedRecords = data.preview;
                    showAlert('uploadResult', data.message, 'success');

                    const previewSection = document.getElementById('previewSection');
                    const previewTable = document.getElementById('previewTable');

                    const headers = Object.keys(data.preview[0]);
                    previewTable.querySelector('thead').innerHTML = `
                        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    `;

                    previewTable.querySelector('tbody').innerHTML = data.preview.map(record => `
                        <tr>${headers.map(h => `<td class="text-truncate" title="${record[h] || ''}">${record[h] || ''}</td>`).join('')}</tr>
                    `).join('');

                    previewSection.classList.remove('hidden');

                    // æ›´æ–°å³ä¾§ç»Ÿè®¡
                    document.getElementById('totalCount').textContent = data.total;
                    document.getElementById('currentIndex').textContent = `0 / ${data.total}`;

                    // å¯ç”¨æŒ‰é’®
                    if (currentModels.length > 0) {
                        document.getElementById('analyzeBtn').disabled = false;
                        document.getElementById('exportBtn').disabled = false;
                    }
                } else {
                    showAlert('uploadResult', data.error || 'ä¸Šä¼ å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('uploadResult', 'ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // AIå¹³å°é…ç½®
        const AI_PLATFORMS = {
            doubao: {
                name: 'è±†åŒ…',
                url: 'https://www.doubao.com',
                color: '#667eea'
            },
            zhipu: {
                name: 'æ™ºè°±æ¸…è¨€',
                url: 'https://chatglm.cn',
                color: '#1a5f7a'
            },
            deepseek: {
                name: 'DeepSeek',
                url: 'https://chat.deepseek.com',
                color: '#4a5568'
            },
            kimi: {
                name: 'Kimi',
                url: 'https://kimi.moonshot.cn',
                color: '#10b981'
            },
            qwen: {
                name: 'é€šä¹‰åƒé—®',
                url: 'https://tongyi.aliyun.com',
                color: '#8b5cf6'
            },
            yiyan: {
                name: 'æ–‡å¿ƒä¸€è¨€',
                url: 'https://yiyan.baidu.com',
                color: '#3b82f6'
            }
        };

        // ç”Ÿæˆå®Œæ•´çš„AIä¼˜åŒ–æç¤ºè¯
        function generateFullPrompt() {
            const criteria = document.getElementById('userCriteria').value.trim();
            const promptBox = document.getElementById('fullPromptText');
            
            if (!criteria) {
                promptBox.textContent = 'è¯·å…ˆåœ¨ä¸Šæ–¹çš„"è¾“å…¥ç­›é€‰æ ‡å‡†"æ¡†ä¸­è¾“å…¥æ‚¨çš„ç­›é€‰æ ‡å‡†...';
                promptBox.classList.add('placeholder');
                return;
            }
            
            promptBox.classList.remove('placeholder');
            
            const fullPrompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ–‡çŒ®ç­›é€‰ä¸“å®¶ã€‚è¯·å¸®æˆ‘ä¼˜åŒ–ä»¥ä¸‹ç­›é€‰æ ‡å‡†ï¼Œä½¿å…¶æ›´åŠ ç²¾ç¡®ã€æ¸…æ™°ã€æ˜“äºè¢«AIç†è§£ã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ä¼˜åŒ–è¦æ±‚ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. åˆ†æç”¨æˆ·çš„ç­›é€‰æ„å›¾ï¼Œè½¬åŒ–ä¸ºä¸“ä¸šã€ç²¾ç¡®çš„å­¦æœ¯æœ¯è¯­
2. å°†æ¨¡ç³Šçš„è‡ªç„¶è¯­è¨€è½¬åŒ–ä¸ºæ¸…æ™°çš„åˆ¤æ–­æ ‡å‡†
3. é€»è¾‘ç»“æ„æ¸…æ™°ï¼Œæ— æ­§ä¹‰
4. ä¿ç•™ç”¨æˆ·åŸå§‹æ„å›¾çš„æ‰€æœ‰å…³é”®ç‚¹
5. ç”¨ä¸­æ–‡è¾“å‡ºä¼˜åŒ–åçš„ç­›é€‰æ ‡å‡†

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€æˆ‘çš„ç­›é€‰æ ‡å‡†ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${criteria}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€è¯·è¾“å‡ºã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¯·ç›´æ¥è¾“å‡ºä¼˜åŒ–åçš„ç­›é€‰æ ‡å‡†æè¿°ï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡Šã€‚ä¼˜åŒ–åçš„å†…å®¹åº”è¯¥æ›´ä¸“ä¸šã€æ›´æ¸…æ™°ã€æ›´æ˜“äºAIç†è§£ã€‚`;

            promptBox.textContent = fullPrompt;
        }

        // ä¸€é”®å¤åˆ¶å®Œæ•´æç¤ºè¯
        async function copyFullPrompt() {
            const promptText = document.getElementById('fullPromptText').textContent;
            const copyBtn = document.querySelector('.btn-copy-small');
            
            if (promptText.includes('è¯·å…ˆåœ¨ä¸Šæ–¹')) {
                alert('è¯·å…ˆè¾“å…¥ç­›é€‰æ ‡å‡†');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(promptText);
                copyBtn.textContent = 'âœ“ å·²å¤åˆ¶';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = 'ä¸€é”®å¤åˆ¶';
                    copyBtn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                // é™çº§æ–¹æ¡ˆ
                const range = document.createRange();
                range.selectNode(document.getElementById('fullPromptText'));
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                
                copyBtn.textContent = 'âœ“ å·²å¤åˆ¶';
                setTimeout(() => {
                    copyBtn.textContent = 'ä¸€é”®å¤åˆ¶';
                }, 2000);
            }
        }

        // æ‰“å¼€AIå¹³å°
        function openAIPlatform(platform) {
            const platformInfo = AI_PLATFORMS[platform];
            const criteria = document.getElementById('userCriteria').value.trim();
            
            if (!criteria) {
                alert('è¯·å…ˆè¾“å…¥ç­›é€‰æ ‡å‡†');
                return;
            }
            
            if (!platformInfo) {
                alert('æœªçŸ¥å¹³å°');
                return;
            }
            
            // å…ˆå°è¯•å¤åˆ¶æç¤ºè¯
            copyFullPrompt();
            
            // æ‰“å¼€AIå¹³å°
            window.open(platformInfo.url, '_blank');
        }

        async function startAnalysis() {
            const prompt = document.getElementById('enhancedPrompt').value;
            const model = document.getElementById('selectedModel').value;

            if (!prompt) {
                alert('è¯·å…ˆç”Ÿæˆç­›é€‰æç¤ºè¯');
                return;
            }

            if (!model) {
                alert('è¯·å…ˆé€‰æ‹©æ¨¡å‹');
                return;
            }

            isAnalyzing = true;
            analysisResults = [];
            const btn = document.getElementById('analyzeBtn');
            btn.innerHTML = '<span class="loading"></span> åˆ†æä¸­...';
            btn.disabled = true;

            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';

            // é‡ç½®ç»Ÿè®¡
            document.getElementById('yesCount').textContent = '0';
            document.getElementById('noCount').textContent = '0';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('analysisProgressBar').style.width = '0%';
            document.getElementById('etaText').textContent = 'å‡†å¤‡åˆ†æ...';

            try {
                console.log('[åˆ†æ] å¼€å§‹å‘é€è¯·æ±‚');
                const response = await fetch('/screen_papers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: model
                    })
                });
                console.log('[åˆ†æ] æ”¶åˆ°å“åº”:', response.status);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        console.log('[åˆ†æ] æµç»“æŸ');
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                console.log('[åˆ†æ] æ”¶åˆ°æ•°æ®:', data.type);

                                if (data.type === 'start') {
                                    // å¼€å§‹åˆ†æ
                                    document.getElementById('totalCount').textContent = data.total;
                                    document.getElementById('currentIndex').textContent = `0 / ${data.total}`;
                                }
                                else if (data.type === 'progress') {
                                    // å½“å‰æ­£åœ¨åˆ†æçš„è¿›åº¦
                                    const progress = Math.round((data.current / data.total) * 100);
                                    document.getElementById('progressPercent').textContent = progress + '%';
                                    document.getElementById('analysisProgressBar').style.width = progress + '%';
                                    document.getElementById('currentIndex').textContent = `${data.current} / ${data.total}`;
                                    
                                    // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒæ–‡æœ¬
                                    let statusText = `æ­£åœ¨åˆ†æç¬¬ ${data.current} ç¯‡...`;
                                    if (data.status === 'loading') {
                                        statusText = 'æ¨¡å‹é¦–æ¬¡åŠ è½½ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ˆå¯èƒ½éœ€è¦1-3åˆ†é’Ÿï¼‰...';
                                    }
                                    document.getElementById('etaText').textContent = statusText;

                                    // æ·»åŠ æˆ–æ›´æ–°å½“å‰åˆ†æé¡¹åˆ°æ—¥å¿—
                                    const existingItem = document.getElementById(`log-item-${data.current}`);
                                    if (existingItem) {
                                        existingItem.querySelector('.log-title').textContent = data.title;
                                    } else {
                                        const logItem = document.createElement('div');
                                        logItem.id = `log-item-${data.current}`;
                                        logItem.className = 'log-item analyzing';
                                        logItem.innerHTML = `
                                            <div class="log-index">${data.current}</div>
                                            <div class="log-title">${data.title}</div>
                                            <div class="log-result analyzing">åˆ†æä¸­...</div>
                                        `;
                                        logContainer.appendChild(logItem);
                                        // åªæ»šåŠ¨æ—¥å¿—å®¹å™¨ï¼Œä¸æ»šåŠ¨æ•´ä¸ªé¡µé¢
                                        logContainer.scrollTop = logContainer.scrollHeight;
                                    }
                                }
                                else if (data.type === 'result') {
                                    // å•ç¯‡åˆ†æç»“æœ
                                    const result = data.data;
                                    analysisResults.push(result);

                                    // ç¡®å®šç»“æœç±»å‹
                                    let resultClass = '';
                                    let logClass = '';
                                    if (result.result === 'æ˜¯') {
                                        resultClass = 'yes';
                                        logClass = 'yes';
                                    } else if (result.result === 'å¦') {
                                        resultClass = 'no';
                                        logClass = 'no';
                                    } else {
                                        resultClass = 'unknown';
                                        logClass = 'unknown';
                                    }

                                    // æ›´æ–°æ—¥å¿—é¡¹æ˜¾ç¤ºç»“æœ
                                    const logItem = document.getElementById(`log-item-${result.index}`);
                                    if (logItem) {
                                        logItem.className = `log-item ${resultClass}`;
                                        // è§£æ raw_response æå–åˆ†ç±»ä¾æ®ã€åŸå› å’Œç»“æœ
                                        const rawResponse = result.raw_response || '';
                                        let basis = '', reason = '', classificationResult = result.result;
                                        
                                        // æå–ã€åˆ†ç±»ä¾æ®ã€‘
                                        const basisMatch = rawResponse.match(/ã€åˆ†ç±»ä¾æ®ã€‘\s*\n?([^ã€]+)/);
                                        if (basisMatch) basis = basisMatch[1].trim();
                                        
                                        logItem.innerHTML = `
                                            <div class="log-header">
                                                <div class="log-index log-${logClass}">${result.index}</div>
                                                <div class="log-title">${result.title}</div>
                                                <div class="log-result result-${resultClass}">${result.result}</div>
                                                <button class="btn-expand" onclick="toggleLogDetails(${result.index})">è¯¦æƒ…</button>
                                            </div>
                                            <div class="log-details" id="log-details-${result.index}">
                                                <div class="log-details-content">${rawResponse || 'æš‚æ— åˆ†æè¯¦æƒ…'}</div>
                                            </div>
                                        `;
                                    }

                                    // æ›´æ–°ç»Ÿè®¡
                                    const yesCount = analysisResults.filter(r => r.result === 'æ˜¯').length;
                                    const noCount = analysisResults.filter(r => r.result === 'å¦').length;
                                    const unknownCount = analysisResults.filter(r => r.result === 'æœªçŸ¥').length;
                                    document.getElementById('yesCount').textContent = yesCount;
                                    document.getElementById('noCount').textContent = noCount;
                                    document.getElementById('unknownCount').textContent = unknownCount;
                                }
                                else if (data.type === 'ai_interaction') {
                                    // AIäº¤äº’å†…å®¹ - å‘é€åˆ°æŠ½å±‰
                                    if (data.interaction_type === 'send') {
                                        addAIInteraction(data.paper_id, 'send', data.content, data.label);
                                    } else if (data.interaction_type === 'receive') {
                                        addAIInteraction(data.paper_id, 'receive', data.content, data.label);
                                    }
                                }
                                else if (data.type === 'complete') {
                                    // åˆ†æå®Œæˆ
                                    document.getElementById('progressPercent').textContent = '100%';
                                    document.getElementById('analysisProgressBar').style.width = '100%';
                                    document.getElementById('etaText').textContent = 'åˆ†æå®Œæˆ';
                                    
                                    // ç»“æŸæµå¼æ˜¾ç¤º
                                    finalizeStreaming();

                                    // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                                    document.getElementById('downloadSection').classList.remove('hidden');
                                    document.getElementById('resultDownloadUrl').value = data.download_url;

                                    // æ›´æ–°æœ€ç»ˆç»Ÿè®¡
                                    document.getElementById('yesCount').textContent = data.summary.yes;
                                    document.getElementById('noCount').textContent = data.summary.no;
                                    document.getElementById('unknownCount').textContent = data.summary.unknown || 0;
                                }
                            } catch (e) {
                                console.error('è§£ææ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('[åˆ†æ] é”™è¯¯:', error);
                alert('åˆ†æå¤±è´¥: ' + error.message);
            } finally {
                isAnalyzing = false;
                btn.innerHTML = '<span>â–¶</span> å¼€å§‹åˆ†æ';
                btn.disabled = false;
            }
        }

        // åˆ‡æ¢æ—¥å¿—è¯¦æƒ…å±•å¼€/æ”¶èµ·
        function toggleLogDetails(index) {
            const details = document.getElementById(`log-details-${index}`);
            if (details) {
                details.classList.toggle('expanded');
            }
        }

        // åˆ‡æ¢å•ä¸ªæ ç›®å†…å®¹çš„å±•å¼€/æ”¶èµ·
        function toggleSectionContent(label, contentId) {
            const content = document.getElementById(contentId);
            if (content) {
                content.classList.toggle('expanded');
                label.classList.toggle('collapsed');
            }
        }

        async function exportWithoutAnalysis() {
            if (!parsedRecords || parsedRecords.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡çŒ®æ–‡ä»¶');
                return;
            }
            
            const btn = document.getElementById('exportBtn');
            btn.innerHTML = '<span class="loading"></span> å¯¼å‡ºä¸­...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/export_parsed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = data.download_url;
                } else {
                    alert(data.error || 'å¯¼å‡ºå¤±è´¥');
                }
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            } finally {
                btn.innerHTML = '<span>ğŸ“¥</span> ä¸åˆ†æå¯¼å‡ºExcel';
                btn.disabled = false;
            }
        }

        function downloadResult() {
            const url = document.getElementById('resultDownloadUrl').value;
            if (url) {
                window.location.href = url;
            }
        }

        // ===== AIäº¤äº’æŠ½å±‰åŠŸèƒ½ =====
        let aiInteractionCount = 0;
        let currentStreamingElement = null;

        function toggleAIInteractionDrawer() {
            const drawer = document.getElementById('aiInteractionDrawer');
            const overlay = document.getElementById('drawerOverlay');
            drawer.classList.toggle('open');
            overlay.classList.toggle('open');
            
            // æ¸…é™¤badge
            if (drawer.classList.contains('open')) {
                const badge = document.querySelector('.drawer-toggle-btn .badge');
                if (badge) {
                    badge.style.display = 'none';
                    aiInteractionCount = 0;
                }
            }
        }

        function closeAIInteractionDrawer() {
            const drawer = document.getElementById('aiInteractionDrawer');
            const overlay = document.getElementById('drawerOverlay');
            drawer.classList.remove('open');
            overlay.classList.remove('open');
        }

        function addAIInteraction(paperId, type, content, label = '') {
            const container = document.getElementById('aiInteractionContent');
            const time = new Date().toLocaleTimeString('zh-CN');
            
            const item = document.createElement('div');
            item.className = `interaction-item ${type}`;
            item.innerHTML = `
                <div class="interaction-header">
                    <span class="interaction-paper-id">#${paperId}</span>
                    <span class="interaction-type ${type}">${type === 'send' ? 'ğŸ“¤ å‘é€' : 'ğŸ“¥ æ¥æ”¶'}</span>
                    <span class="interaction-time">${time}</span>
                </div>
                <div class="interaction-content">
                    ${label ? `<div class="interaction-label">${label}</div>` : ''}
                    <div class="interaction-text ${type === 'receive' ? 'streaming' : ''}">${escapeHtml(content)}</div>
                </div>
            `;
            
            container.appendChild(item);
            container.scrollTop = container.scrollHeight;
            
            // æ›´æ–°badge
            const drawer = document.getElementById('aiInteractionDrawer');
            if (!drawer.classList.contains('open')) {
                aiInteractionCount++;
                const badge = document.querySelector('.drawer-toggle-btn .badge');
                if (badge) {
                    badge.textContent = aiInteractionCount;
                    badge.style.display = 'inline-block';
                }
            }
            
            // å¦‚æœæ˜¯æ¥æ”¶ç±»å‹ï¼Œä¿å­˜å¼•ç”¨ä»¥ä¾¿æµå¼æ›´æ–°
            if (type === 'receive') {
                currentStreamingElement = item.querySelector('.interaction-text');
            }
            
            return item;
        }

        function updateStreamingContent(content) {
            if (currentStreamingElement) {
                currentStreamingElement.textContent = content;
                const container = document.getElementById('aiInteractionContent');
                container.scrollTop = container.scrollHeight;
            }
        }

        function finalizeStreaming() {
            if (currentStreamingElement) {
                currentStreamingElement.classList.remove('streaming');
                currentStreamingElement = null;
            }
        }

        function clearAIInteractions() {
            const container = document.getElementById('aiInteractionContent');
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ç­‰å¾…AIäº¤äº’...</div>';
            aiInteractionCount = 0;
            currentStreamingElement = null;
            const badge = document.querySelector('.drawer-toggle-btn .badge');
            if (badge) badge.style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç›‘å¬ESCé”®å…³é—­æŠ½å±‰
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAIInteractionDrawer();
            }
        });
    </script>

    <!-- AIäº¤äº’æŠ½å±‰ -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="closeAIInteractionDrawer()"></div>
    <div class="ai-interaction-drawer" id="aiInteractionDrawer">
        <div class="drawer-header">
            <div class="drawer-title">
                <span>ğŸ¤–</span>
                <span>AIäº¤äº’è¯¦æƒ…</span>
            </div>
            <button class="drawer-close" onclick="closeAIInteractionDrawer()">&times;</button>
        </div>
        <div class="drawer-content" id="aiInteractionContent">
            <div style="text-align: center; color: #999; padding: 40px;">ç­‰å¾…AIäº¤äº’...</div>
        </div>
        <div class="drawer-actions">
            <button class="drawer-btn" onclick="clearAIInteractions()">ğŸ—‘ï¸ æ¸…ç©º</button>
            <button class="drawer-btn primary" onclick="closeAIInteractionDrawer()">å…³é—­</button>
        </div>
    </div>

    <!-- æŠ½å±‰åˆ‡æ¢æŒ‰é’® -->
    <button class="drawer-toggle-btn" onclick="toggleAIInteractionDrawer()">
        <span>ğŸ¤–</span>
        <span>AIäº¤äº’</span>
        <span class="badge" style="display: none;">0</span>
    </button>
</body>
</html>